<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<!-- The provider will inject a full CSP string here -->
<meta http-equiv="Content-Security-Policy" content="{{CSP}}" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TB-Studio</title>
<style>
:root { color-scheme: light dark; }
body { font: 13px/1.4 var(--vscode-font-family); color: var(--vscode-foreground); padding: 12px; }
.card { background: var(--vscode-editor-background); border: 1px solid var(--vscode-panel-border); border-radius: 8px; padding: 12px;min-height: 94vh; height: auto; }
button { margin-top:10px; padding:6px 10px; border:1px solid var(--vscode-button-border); background: var(--vscode-button-background); color: #FFFFFF; border-radius:4px; cursor:pointer; }
.muted { color: var(--vscode-descriptionForeground); }
.widget { padding:6px 8px; border-bottom: 1px solid var(--vscode-panel-border); cursor:pointer;}
.widget:hover { background: var(--vscode-list-hoverBackground); }
.row { display:flex; gap:8px; align-items:center; justify-content: space-between; }
</style>
</head>
<body>
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="font-size:24px; font-weight: 600;">TB-Studio</div>
        <div><small>Server: {{connectedServer}}</small></div>
    </div>
    <div class="row" style="border-bottom: 1px solid var(--vscode-panel-border);margin-bottom: 15px;">
        <div>
            <div>Signed in as <strong id="username">{{username}}</strong></div>
        </div>
        <div>
            <button id="reload" type="button"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#FFFFFF"><path d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z"/></svg></button>
            <button id="logout" type="button"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#FFFFFF"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-160-55-58 102-102H360v-80h327L585-622l55-58 200 200-200 200Z"/></svg></button>
        </div>
    </div>
    <div style="padding: 8px;background-color: rgb(0, 126, 185); color: #FFFFFF;">
        <div style="font-size: 20px;" id="displayName">Available Widgets</div>
    </div>
    
    <div id="widgets" class="muted">Fetching widgetsâ€¦</div>
</div>


<script nonce="{{NONCE}}">
const vscode = acquireVsCodeApi();
const $ = (id) => document.getElementById(id);
document.getElementById('logout').addEventListener('click', () => vscode.postMessage({ type: 'logout' }));
document.getElementById('reload').addEventListener('click', () => vscode.postMessage({ type: 'home' }));
window.addEventListener('DOMContentLoaded', () => {
    vscode.postMessage({type: 'update-settings'});
    vscode.postMessage({ type: 'reload' });
});
window.addEventListener('message', (event) => {
    const msg = event.data;
    const container = $('widgets');
    container.innerHTML = '';
    $('displayName').textContent = 'Available Widgets';
    if (msg.type === 'widget-bundle-type') {
        $('displayName').textContent = 'Widget: '+msg.payload.displayName || 'Available Widget Types';
        (msg?.payload?.widgets || []).forEach((w) => {
            const el = document.createElement('div');
            el.className = 'widget';
            el.textContent = w.name;
            el.addEventListener('click', () => vscode.postMessage({ type: 'widget-bundle-type', payload: { widget: w } }));
            container.appendChild(el);
        });
        if (!msg?.payload?.widgets?.length) container.textContent = 'No widget types.';
    }
    if (msg?.type === 'widgets') {
        (msg.widgets || []).forEach((w) => {
            const el = document.createElement('div');
            el.className = 'widget';
            el.textContent = w.name;
            el.addEventListener('click', () => vscode.postMessage({ type: 'widget-bundle', payload: { widget: w } }));
            container.appendChild(el);
        });
        if (!msg.widgets?.length) container.textContent = 'No widgets.';
    } else if (msg?.type === 'error') {
        $('widgets').textContent = msg.message || 'Something went wrong.';
    }
});
</script>
</body>
</html>